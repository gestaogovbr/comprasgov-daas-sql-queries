WITH temp1 AS (
	SELECT
		a11.ID_FRND_FORNECEDOR_COMPRA  		AS ID_FRND_FORNECEDOR,
		a12.ID_CMPR_COMPRA  				AS DS_CMPR_COMPRA_EDIT,
		a11.ID_ITCP_ITEM_COMPRA  			AS ID_ITCP_ITEM_COMPRA
	FROM    Siasg_DW_VBL.F_ITEM_FORNECEDOR				a11
		JOIN    Siasg_DW_VBL.D_CMPR_COMPRA				a12
		ON     (a11.ID_CMPR_COMPRA = a12.ID_CMPR_COMPRA)
		JOIN    Siasg_DW_VBL.D_CMPR_MODALIDADE_COMPRA	a13
		ON     (a12.ID_CMPR_MODALIDADE_COMPRA = a13.ID_CMPR_MODALIDADE_COMPRA)
		JOIN    Siasg_DW_VBL.D_DT_DATA					a14
		ON     (a12.DT_CMPR_RESULTADO_COMPRA = a14.ID_DT_DATA)
	WHERE    (a13.ID_CMPR_MODALIDADE_GRUPO in (6)
		AND a12.ID_CMPR_IN_COTACAO_ELETR in (1)
		AND a14.ID_DT_ANO = 2021)
	GROUP BY
		a11.ID_FRND_FORNECEDOR_COMPRA,
		a12.ID_CMPR_COMPRA,
		a11.ID_ITCP_ITEM_COMPRA
	HAVING SUM(a11.VL_ULT_LANCE) >=  0.0 
)
, temp2 AS (
	SELECT
		a15.ID_DT_MES					AS ID_DT_MES,
		pa12.DS_CMPR_COMPRA_EDIT		AS DS_CMPR_COMPRA_EDIT,
		a13.DS_CMPR_COMPRA_EDIT			AS DS_CMPR_COMPRA,
		pa12.ID_ITCP_ITEM_COMPRA		AS ID_ITCP_ITEM_COMPRA,
		a16.CH_ITCP_ITEM_COMPRA_EDIT	AS DS_ITCP_ITEM_COMPRA,
		count(a11.ID_FRND_FORNECEDOR)	AS CONTA_ID_FRND_FORNECEDOR
	FROM    Siasg_DW_VBL.D_FRND_FORNECEDOR				a11
		JOIN    temp1									pa12
		ON     (a11.ID_FRND_FORNECEDOR = pa12.ID_FRND_FORNECEDOR)
		JOIN    Siasg_DW_VBL.D_CMPR_COMPRA				a13
		ON     (pa12.DS_CMPR_COMPRA_EDIT = a13.ID_CMPR_COMPRA)
		JOIN    Siasg_DW_VBL.D_CMPR_MODALIDADE_COMPRA	a14
		ON     (a13.ID_CMPR_MODALIDADE_COMPRA = a14.ID_CMPR_MODALIDADE_COMPRA)
		JOIN    Siasg_DW_VBL.D_DT_DATA					a15
		ON     (a13.DT_CMPR_RESULTADO_COMPRA = a15.ID_DT_DATA)
		JOIN    Siasg_DW_VBL.D_ITCP_ITEM_COMPRA			a16
		ON     (pa12.ID_ITCP_ITEM_COMPRA = a16.ID_ITCP_ITEM_COMPRA)
	WHERE    (a14.ID_CMPR_MODALIDADE_GRUPO in (6)
		AND a13.ID_CMPR_IN_COTACAO_ELETR in (1)
		AND A15.ID_DT_ANO = 2021)
	 AND a13.DS_CMPR_COMPRA_EDIT IN (
		07001206000272021,
		07001206000312021,
		11320306000962021,
		11320306000972021,
		11460406000042021,
		11460406000052021,
		11460906000122021,
		11461006000312021,
		11462406000082021,
		12001406000612021,
		12001406000642021,
		13002406000072021,
		13005706000052021,
		13010206000352021,
		13500506000162021,
		13500506000202021,
		13500506000242021,
		13500706000252021,
		13501406000202021,
		13502606000252021,
		13502606000392021,
		13502806000272021,
		13502906010102021,
		13503206010072021,
		13503506000202021,
		13509706000082021,
		13519206000112021,
		15308806000052021,
		15308806000062021,
		15312806000022021,
		15316106000172021,
		15316106000182021,
		15316106000202021,
		15316106000212021,
		15327606000272021,
		15327906000042021,
		15327906000072021,
		15327906000092021,
		15327906000102021,
		15327906000122021,
		15329206000052021,
		15329206000072021,
		15329406000102021,
		15458006000112021,
		15501106002612021,
		15502106002412021,
		15590006000132021,
		15590406000932021,
		15590406000982021,
		15590406001012021,
		15590406001022021,
		15590406001032021,
		15590406001052021,
		15590406001072021,
		15590406001082021,
		15590806000092021,
		15591106001062021,
		15591106001072021,
		15591106001122021,
		15606006000022021,
		15667806000142021,
		15667806000162021,
		15667906031162021,
		15800906001102021,
		15800906001312021,
		15812406000662021,
		15813406000042021,
		15814606000152021,
		15814606000202021,
		15815106000462021,
		15815406000022021,
		15828806000052021,
		15831906000062021,
		15840506000032021,
		15842406000202021,
		15844206000032021,
		15844206000042021,
		15845506000032021,
		15845706000052021,
		15846906000062021,
		15852206000012021,
		16000206000612021,
		16000206000672021,
		16000206000682021,
		16000606001012021,
		16000706001022021,
		16001206000662021,
		16001206000682021,
		16001206000712021,
		16001506000722021,
		16001506000732021,
		16001506000742021,
		16001506000842021,
		16001806000372021,
		16001806000392021,
		16001806000402021,
		16003406000732021,
		16003606001032021,
		16003606001112021,
		16004906000542021,
		16004906000552021,
		16004906000582021,
		16005606000142021,
		16006806000862021,
		16007206000442021,
		16007206000452021,
		16007206000522021,
		16007206000532021,
		16007906000292021,
		16008506000402021,
		16008906000272021,
		16008906000282021,
		16009006000032021,
		16009006000352021,
		16009006000422021,
		16009106000352021,
		16009106000362021,
		16012306001022021,
		16014706000742021,
		16014706000782021,
		16016006000562021,
		16016006000572021,
		16016006000582021,
		16016006000592021,
		16016006000602021,
		16016006000612021,
		16016006000632021,
		16016006000642021,
		16016006000662021,
		16016006000672021,
		16016306000242021,
		16017006000652021,
		16017506000252021,
		16019206001752021,
		16019206001802021,
		16019206001812021,
		16019206001842021,
		16019206001852021,
		16019206001862021,
		16019206001882021,
		16019206001912021,
		16019206001932021,
		16019206001942021,
		16019206002012021,
		16019506000432021,
		16021306000742021,
		16021306000832021,
		16021706001222021,
		16021706001232021,
		16021706001242021,
		16021706001252021,
		16021706001262021,
		16021706001302021,
		16021706001312021,
		16021706001322021,
		16021706001392021,
		16021706001402021,
		16021706001412021,
		16021706001422021,
		16021706001432021,
		16022206001342021,
		16022206001392021,
		16022206001412021,
		16025006001212021,
		16025006001222021,
		16025006001232021,
		16025006001242021,
		16025006001262021,
		16025006001272021,
		16025006001282021,
		16025006001322021,
		16025006004432021,
		16025106000762021,
		16025106000782021,
		16029106000502021,
		16029106000522021,
		16029206000162021,
		16029706000762021,
		16029806000442021,
		16029806000472021,
		16029806000482021,
		16029806000492021,
		16029806000512021,
		16031106001492021,
		16033606000352021,
		16033806001532021,
		16034206000262021,
		16034906001092021,
		16035006000342021,
		16035406001022021,
		16035406001042021,
		16035406001052021,
		16036006001172021,
		16036006001182021,
		16036006001222021,
		16036306000882021,
		16038406000712021,
		16038406000752021,
		16038406000762021,
		16038906000632021,
		16039506001512021,
		16039506001592021,
		16039506001602021,
		16039906001112021,
		16040306001612021,
		16040306001632021,
		16040306001652021,
		16040306001662021,
		16040306001672021,
		16040306001732021,
		16040306001742021,
		16041306001132021,
		16042106000282021,
		16043106000922021,
		16043606000552021,
		16043606000612021,
		16043806001702021,
		16043806001712021,
		16043806001722021,
		16043806001802021,
		16043806001812021,
		16043806001822021,
		16043806001922021,
		16043806001932021,
		16043806001942021,
		16043806001952021,
		16043806002022021,
		16047206000572021,
		16047206000582021,
		16047206000612021,
		16047206000632021,
		16047206000642021,
		16047206000652021,
		16047406000552021,
		16047906000772021,
		16048006000972021,
		16051706002222021,
		16051706002252021,
		16051706002262021,
		16051706002272021,
		16051706002312021,
		16051706002332021,
		16051706002342021,
		16051706002382021,
		16051706002392021,
		16051706002492021,
		16051706002542021,
		16051706002562021,
		16052306001732021,
		16052306001752021,
		16052306001822021,
		16052306001832021,
		16052306001842021,
		16052306001852021,
		16052306001872021,
		16052306001882021,
		16052306001892021,
		16052306001912021,
		16052306001922021,
		16052306001942021,
		16052406000652021,
		16053706001082021,
		16053706001102021,
		16053706001142021,
		16054706000762021,
		16054706000802021,
		16054706000812021,
		16054706000832021,
		16054806000162021,
		17002506000042021,
		17002506000052021,
		17003206000132021,
		17003206000142021,
		17014706000022021,
		17018406000242021,
		17018406000252021,
		17019006000162021,
		17020106000402021,
		17908706000092021,
		19000406000142021,
		19406806000042021,
		20011506000292021,
		20011606000222021,
		20012606000082021,
		20014106000062021,
		20034006000202021,
		20034606000062021,
		20037006000342021,
		20037606000082021,
		20038606000082021,
		20038606000152021,
		20060206000432021,
		20060206000442021,
		24012306000112021,
		24012606001212021,
		24012706000382021,
		24012706000392021,
		24012706004022021,
		24030006000122021,
		27507906000092021,
		32000406000102021,
		32000406000112021,
		32000406000122021,
		32000406000142021,
		34301006000062021,
		34301306000042021,
		34404206000272021,
		34404206000472021,
		38908706000012021,
		38908706000022021,
		38916706000062021,
		38918206000062021,
		38919506000042021,
		38919506000052021,
		38929806000212021,
		38929806000232021,
		38946106000132021,
		40320106001042021,
		41000306000092021,
		46293906000012021,
		46293906000022021,
		77100006000072021,
		77100006000082021,
		78201906000472021,
		78300006000032021,
		78333006000052021,
		79117006000032021,
		79119106000012021,
		79538006000102021,
		79540006005012021,
		92509606019722021,
		92518106000122021,
		92601906000022021,
		92609906000012021,
		92612806004732021,
		92612806006192021,
		92612806006492021,
		92612806006942021,
		92612806007102021,
		92612806007202021,
		92612806007372021,
		92798806000152021,
		92798806000172021,
		92836206000012021,
		98659306001812021,
		98659306101512021)
	GROUP BY
		a15.ID_DT_MES,
		pa12.DS_CMPR_COMPRA_EDIT,
		a13.DS_CMPR_COMPRA_EDIT,
		pa12.ID_ITCP_ITEM_COMPRA,
		a16.CH_ITCP_ITEM_COMPRA_EDIT
)
SELECT ID_DT_MES as anomes, CAST(AVG(CONTA_ID_FRND_FORNECEDOR) AS FLOAT) AS mediaparticipantesdispensaletronica, COUNT(DISTINCT DS_CMPR_COMPRA) AS contacompras, COUNT(DISTINCT DS_ITCP_ITEM_COMPRA) AS contaitens, NOW() AS datahoraregisto
FROM temp2
GROUP BY ID_DT_MES
ORDER BY ID_DT_MES